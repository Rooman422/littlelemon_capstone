{% extends "base.html" %}

{% block title %}Book a Table - Little Lemon{% endblock %}

{% block content %}
  <h2>Book a Table</h2>
  <form id="booking-form">
    <label for="name">Name:</label><br>
    <input type="text" id="name" name="name" required><br><br>

    <label for="no_of_guests">Number of Guests:</label><br>
    <input type="number" id="no_of_guests" name="no_of_guests" min="1" required><br><br>

    <label for="booking_date">Date:</label><br>
    <input type="date" id="booking_date" name="booking_date" required><br><br>

    <label for="booking_time">Time:</label><br>
    <input type="time" id="booking_time" name="booking_time" required><br><br>

    <button type="submit">Submit Booking</button>
  </form>

  <!-- Modal -->
  <div id="successModal" style="display: none; position: fixed; top: 0; left: 0; 
    width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); 
    justify-content: center; align-items: center; z-index: 9999;">
    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
      <h2>Booking Confirmed!</h2>
      <p id="modalMessage"></p>
      <button onclick="closeModal()">Close</button>
    </div>
  </div>

  <div id="response" style="margin-top: 1rem; color: red;"></div>

  <hr>

  <h3>View Bookings for a Date</h3>
  <input type="date" id="view-date">
  <button type="button" onclick="fetchBookingsForDate()">Show Bookings</button>

  <div id="booking-list" style="margin-top: 1rem;"></div>
{% endblock %}

{% block extra_head %}
<script>
  const form = document.getElementById('booking-form');
  const responseDiv = document.getElementById('response');

  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    const data = {
      name: form.name.value,
      no_of_guests: parseInt(form.no_of_guests.value),
      booking_date: form.booking_date.value,
      booking_time: form.booking_time.value
    };

    await submitBooking(data);
  });

  async function submitBooking(data) {
    const accessToken = localStorage.getItem('access');
    let response = await fetch('/api/bookings/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${accessToken}`
      },
      body: JSON.stringify(data)
    });

    if (response.ok) {
      const result = await response.json();
      showModal(`Reservation for ${result.name} at ${result.booking_time} confirmed!`);
      form.reset();
    } else if (response.status === 401) {
      const refreshSuccess = await refreshToken();
      if (refreshSuccess) {
        await submitBooking(data);
      } else {
        responseDiv.textContent = 'Login expired. Please login again.';
        window.location.href = "/login";
      }
    } else {
      const error = await response.json();
      responseDiv.textContent = 'Error: ' + JSON.stringify(error);
    }
  }

  async function refreshToken() {
    const refreshToken = localStorage.getItem('refresh');
    const response = await fetch('/api/token/refresh/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ refresh: refreshToken })
    });

    if (response.ok) {
      const data = await response.json();
      localStorage.setItem('access', data.access);
      return true;
    } else {
      return false;
    }
  }

  async function fetchBookingsForDate() {
    const date = document.getElementById('view-date').value;
    const bookingListDiv = document.getElementById('booking-list');
    const accessToken = localStorage.getItem('access');

    if (!date) {
      bookingListDiv.textContent = "Please select a date.";
      return;
    }

    let response = await fetch(`/api/bookings/?booking_date=${date}`, {
      headers: {
        'Authorization': `Bearer ${accessToken}`
      }
    });

    if (response.ok) {
      const bookings = await response.json();
      if (bookings.length === 0) {
        bookingListDiv.textContent = "No bookings found for this date.";
      } else {
        let html = "<ul>";
        bookings.forEach(b => {
          html += `<li><strong>${b.name}</strong> - ${b.booking_time} - ${b.no_of_guests} guests</li>`;
        });
        html += "</ul>";
        bookingListDiv.innerHTML = html;
      }
    } else if (response.status === 401) {
      const refreshed = await refreshToken();
      if (refreshed) {
        fetchBookingsForDate();
      } else {
        bookingListDiv.textContent = "Login expired. Please login again.";
        window.location.href = "/login";
      }
    } else {
      bookingListDiv.textContent = "Error fetching bookings.";
    }
  }

  // âœ… Modal functions must be outside the fetch function
  function showModal(message) {
    const modal = document.getElementById("successModal");
    const modalMsg = document.getElementById("modalMessage");
    modalMsg.textContent = message;
    modal.style.display = "flex";
  }

  function closeModal() {
    document.getElementById("successModal").style.display = "none";
  }
</script>
{% endblock %}
